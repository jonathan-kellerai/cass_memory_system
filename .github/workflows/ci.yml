name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Prevent duplicate workflow runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run typecheck

      - name: Guardrail (tests must not use bun mocks)
        run: |
          set -euo pipefail

          if command -v rg >/dev/null 2>&1; then
            if rg -n "\\bmock\\(" test; then
              echo "::error::Forbidden bun:test mock() usage detected in test/**. Use closure-based spies/counters instead (see test/llm-with-retry.test.ts)."
              exit 1
            fi

            if rg -n "mock\\.module\\(" test; then
              echo "::error::Forbidden module mocking detected in test/**. Use dependency injection / injected providers instead (see src/llm.ts LLMIO + test/llm.mocked.test.ts)."
              exit 1
            fi
          else
            echo "rg not found; falling back to grep"

            if grep -R -n -E '(^|[^A-Za-z0-9_])mock\\(' test; then
              echo "::error::Forbidden bun:test mock() usage detected in test/**. Use closure-based spies/counters instead."
              exit 1
            fi

            if grep -R -n -E 'mock\\.module\\(' test; then
              echo "::error::Forbidden module mocking detected in test/**. Use dependency injection / injected providers instead."
              exit 1
            fi
          fi

      - name: Run tests
        run: bun run test:ci

  coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      # Phase 1 thresholds (raise intentionally via PRs).
      COVERAGE_MIN_FUNCS: "70"
      COVERAGE_MIN_LINES: "70"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests with coverage (offline)
        run: bash scripts/coverage.sh
        env:
          LOG_DIR: ${{ runner.temp }}/cm-coverage

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-artifacts
          path: ${{ runner.temp }}/cm-coverage
          if-no-files-found: warn

      - name: Enforce coverage thresholds
        run: |
          bun -e '
            const fs = require("fs");
            const path = require("path");

            const logDir = process.env.LOG_DIR;
            const summaryPath = path.join(logDir, "summary.json");
            const minFuncs = Number(process.env.COVERAGE_MIN_FUNCS || 0);
            const minLines = Number(process.env.COVERAGE_MIN_LINES || 0);

            const summary = JSON.parse(fs.readFileSync(summaryPath, "utf8"));
            const funcs = Number(summary?.totals?.funcs ?? 0);
            const lines = Number(summary?.totals?.lines ?? 0);

            const failures = [];
            if (funcs < minFuncs) failures.push(`Functions: ${funcs.toFixed(2)} < ${minFuncs}`);
            if (lines < minLines) failures.push(`Lines: ${lines.toFixed(2)} < ${minLines}`);

            if (failures.length) {
              console.error("Coverage gate failed:");
              for (const f of failures) console.error(`- ${f}`);
              process.exit(1);
            }

            console.log(`Coverage gate passed: funcs=${funcs.toFixed(2)} lines=${lines.toFixed(2)}`);
          '
        env:
          LOG_DIR: ${{ runner.temp }}/cm-coverage

      - name: Show coverage summary on failure
        if: failure()
        run: |
          echo "---- summary.json ----"
          cat "${LOG_DIR}/summary.json" || true
          echo "---- coverage.txt (tail) ----"
          tail -n 60 "${LOG_DIR}/artifacts/coverage.txt" || true
        env:
          LOG_DIR: ${{ runner.temp }}/cm-coverage

  e2e-scripts:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run e2e smoke script (offline)
        run: bash scripts/e2e-smoke.sh
        env:
          LOG_DIR: ${{ runner.temp }}/cm-e2e

      - name: Upload e2e artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-smoke-artifacts
          path: ${{ runner.temp }}/cm-e2e
          if-no-files-found: warn

      - name: Show steps.jsonl on failure
        if: failure()
        run: |
          echo "---- steps.jsonl ----"
          cat "${LOG_DIR}/steps.jsonl" || true
        env:
          LOG_DIR: ${{ runner.temp }}/cm-e2e

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lock') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: |
          mkdir -p dist
          bun run build

      - name: Verify binary
        run: |
          chmod +x dist/cass-memory
          ./dist/cass-memory --version
